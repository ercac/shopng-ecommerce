<!-- ============================================================ -->
<!-- PRODUCT DETAIL TEMPLATE                                      -->
<!-- Shows full product info with quantity selector,               -->
<!-- customer reviews, and related products.                       -->
<!-- ============================================================ -->

@if (product) {
  <!-- Back navigation link -->
  <a routerLink="/products" class="back-link">&larr; Back to Products</a>

  <div class="product-detail">
    <!-- ‚îÄ‚îÄ Product Image ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="detail-image">
      <img [src]="product.image" [alt]="product.name" />
    </div>

    <!-- ‚îÄ‚îÄ Product Info ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="detail-info">
      <!-- Category badge -->
      <span class="detail-category">{{ product.category }}</span>

      <!-- Product name -->
      <h1 class="detail-title">{{ product.name }}</h1>

      <!-- Star rating ‚Äî uses computed average when reviews exist -->
      <div class="detail-rating">
        @for (star of getStars(averageRating || product.rating); track $index) {
          <span class="star"
                [class.full]="star === 'full'"
                [class.half]="star === 'half'"
                [class.empty]="star === 'empty'">
            ‚òÖ
          </span>
        }
        <span class="rating-text">
          {{ (averageRating || product.rating).toFixed(1) }} / 5
          @if (reviewCount > 0) {
            <span class="review-count">({{ reviewCount }} {{ reviewCount === 1 ? 'review' : 'reviews' }})</span>
          }
        </span>
      </div>

      <!-- Price -->
      <p class="detail-price">{{ product.price | currency:'USD' }}</p>

      <!-- Stock status -->
      <div class="stock-status">
        @if (product.stock > 0) {
          <span class="in-stock">‚úì In Stock ({{ product.stock }} available)</span>
        } @else {
          <span class="out-of-stock">‚úó Out of Stock</span>
        }
      </div>

      <!-- Quantity Selector -->
      @if (product.stock > 0) {
        <div class="quantity-section">
          <label class="quantity-label">Quantity:</label>
          <div class="quantity-controls">
            <button (click)="decrementQuantity()"
                    [disabled]="quantity <= 1"
                    class="qty-btn">
              ‚àí
            </button>
            <span class="qty-value">{{ quantity }}</span>
            <button (click)="incrementQuantity()"
                    [disabled]="quantity >= product.stock"
                    class="qty-btn">
              +
            </button>
          </div>
        </div>

        <!-- Add to Cart Button -->
        <button (click)="addToCart()" class="btn-add-cart-lg">
          Add to Cart ‚Äî {{ product.price * quantity | currency:'USD' }}
        </button>
      }

      <!-- Full description -->
      <div class="detail-description">
        <h3>Description</h3>
        <p>{{ product.description }}</p>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ Customer Reviews ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <section class="reviews-section">
    <div class="reviews-header">
      <h2>Customer Reviews</h2>

      <!-- Write-a-review button / status -->
      @if (authService.currentUser()) {
        @if (hasReviewed) {
          <span class="reviewed-badge">‚úì You've reviewed this product</span>
        } @else {
          <button (click)="toggleReviewForm()" class="btn-write-review">
            {{ showReviewForm ? 'Cancel' : 'Write a Review' }}
          </button>
        }
      } @else {
        <a routerLink="/login" class="btn-login-review">Log in to write a review</a>
      }
    </div>

    <!-- ‚îÄ‚îÄ Review Form ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    @if (showReviewForm) {
      <div class="review-form">
        <h3>Your Review</h3>

        <!-- Star selector -->
        <div class="star-selector">
          <label>Rating:</label>
          <div class="star-options">
            @for (val of [1, 2, 3, 4, 5]; track val) {
              <button type="button"
                      class="star-btn"
                      [class.selected]="val <= newRating"
                      (click)="newRating = val">
                ‚òÖ
              </button>
            }
            <span class="star-label">{{ newRating }} / 5</span>
          </div>
        </div>

        <!-- Title -->
        <div class="form-group">
          <label for="reviewTitle">Title</label>
          <input id="reviewTitle"
                 type="text"
                 [(ngModel)]="newTitle"
                 placeholder="Summarize your experience"
                 maxlength="100" />
        </div>

        <!-- Comment -->
        <div class="form-group">
          <label for="reviewComment">Review</label>
          <textarea id="reviewComment"
                    [(ngModel)]="newComment"
                    placeholder="What did you like or dislike?"
                    rows="4"
                    maxlength="1000"></textarea>
        </div>

        <button (click)="submitReview()"
                [disabled]="!newTitle.trim() || !newComment.trim()"
                class="btn-submit-review">
          Submit Review
        </button>
      </div>
    }

    <!-- ‚îÄ‚îÄ Review List ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    @if (reviews.length > 0) {
      <div class="review-list">
        @for (review of reviews; track review.id) {
          <div class="review-card">
            <div class="review-card-header">
              <div class="review-stars">
                @for (star of getStars(review.rating); track $index) {
                  <span class="star-sm"
                        [class.full]="star === 'full'"
                        [class.empty]="star === 'empty'">
                    ‚òÖ
                  </span>
                }
              </div>
              <span class="review-title">{{ review.title }}</span>
            </div>

            <div class="review-meta">
              <span class="review-author">{{ review.userName }}</span>
              <span class="review-date">{{ formatDate(review.createdAt) }}</span>
            </div>

            <p class="review-comment">{{ review.comment }}</p>

            <button (click)="markHelpful(review.id)" class="btn-helpful">
              üëç Helpful ({{ review.helpful }})
            </button>
          </div>
        }
      </div>
    } @else {
      <div class="reviews-empty">
        <p>No reviews yet. Be the first to share your thoughts!</p>
      </div>
    }
  </section>

  <!-- ‚îÄ‚îÄ Related Products ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  @if (relatedProducts.length > 0) {
    <section class="related-section">
      <h2>Related Products</h2>
      <div class="related-grid">
        @for (related of relatedProducts; track related.id) {
          <app-product-card
            [product]="related"
            (addedToCart)="onAddToCart($event)" />
        }
      </div>
    </section>
  }

} @else {
  <!-- Loading state -->
  <div class="loading">
    <p>Loading product...</p>
  </div>
}
